<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Product Details</title>
	<link rel="stylesheet" href="style/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
	<style>
		.product-details { max-width: 1200px; margin: 120px auto 40px; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
		.product-details img { width: 100%; height: 400px; object-fit: contain; background: #f5f5f5; border-radius: 6px; }
		.product-info h1 { color: #0d3b5e; margin-bottom: 10px; }
		.product-info .price { color: #e44d26; font-weight: bold; margin: 10px 0; }
		.product-actions { display: flex; gap: 10px; margin-top: 15px; }
	</style>
</head>
<body>
	<div class="navbar">
		<div class="left"> <a href="dashboard.html"><img src="img/store logo with one element on a white background.png" alt=""></a></div>
		<div class="center">
			<form action="" class="search-bar">
				<input type="search" name="search" pattern=".*\S.*" required placeholder="Search Here...">
				<button class="search-btn" type="submit">
					<span>Search</span>
				</button>
			</form>
		</div>
		<div class="right">
			<img src="img/heart-solid.svg" alt="wishlist" class="nav-icon" onclick="toggleWishlist()">
			<img src="img/bell-solid.svg" alt="Security" class="nav-icon" onclick="toggleNotifications()">
			<img src="img/cart-shopping-solid.svg" alt="Cart" class="nav-icon" onclick="toggleCart()">
			<a href="#" class="nav-link"><img src="img/phone-solid.svg" alt="Night Mode" class="nav-icon"></a>
			<div class="cart-dropdown" id="cartDropdown">
				<div class="cart-header">
					<h3><i class="fa-solid fa-cart-shopping"></i> <a href="cart.html">Shopping Cart</a></h3>
				</div>
				<div id="cartDropdownItems"></div>
			</div>
			<div class="wishlist-dropdown" id="wishlistDropdown">
				<div class="wishlist-header">
					<h3><i class="fa-solid fa-heart"></i><a href="wishlist.html"> My Wishlist</a></h3>
				</div>
				<div id="wishlistItems"></div>
			</div>
			<div class="notifications-dropdown" id="notificationsDropdown">
				<div class="notifications-header">
					<h3><i class="fa-solid fa-bell"></i> Notifications</h3>
				</div>
				<div id="notificationsItems"></div>
			</div>
			<div class="user-section">
				<div id="loginSection" style="display: none;">
					<a href="index.html" class="nav-link">
						<img src="img/right-to-bracket-solid.svg" alt="Login" class="nav-icon">
					</a>
				</div>
				<div id="userSection" style="display: none;">
					<span id="username" class="username-text"></span>
					<a href="#" class="nav-link">
						<img src="img/user-solid.svg" alt="Profile" class="nav-icon">
					</a>
					<a href="#" class="nav-link" onclick="logout()">
						<img src="img/right-from-bracket-solid.svg" alt="Logout" class="nav-icon">
					</a>
				</div>
			</div>
		</div>
	</div>

	<div class="product-details">
		<div class="product-image">
			<img id="productImage" src="" alt="Product Image">
		</div>
		<div class="product-info">
			<h1 id="productName"></h1>
			<p id="productSummary"></p>
			<div class="price" id="productPrice"></div>
			<p id="productDescription"></p>
			<div class="product-actions">
				<button id="addToCartBtn" class="add-to-cart"><i class="fa-solid fa-cart-shopping"></i> Add to Cart</button>
				<button id="addToWishlistBtn" class="wishlist-btn" aria-label="Add to wishlist" title="Add to wishlist">
					<i class="fa-solid fa-heart" aria-hidden="true"></i>
				</button>
			</div>
		</div>
	</div>

	<div class="container" style="max-width:1200px; margin: 0 auto 40px;">
		<h2 style="color:#0d3b5e; margin-bottom:10px;">Comments</h2>
		<div id="commentsList" class="comments-list" style="background:#fff; border-radius:8px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.06);"></div>
		<div id="commentFormWrap" style="margin-top:12px;">
			<textarea id="commentInput" rows="3" placeholder="Write a comment..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
			<button id="submitComment" class="add-to-cart" style="margin-top:8px;">Post Comment</button>
			<div id="commentHint" style="display:none; color:#666; margin-top:6px;">Login to post comments</div>
		</div>
	</div>

	<div class="container" style="max-width:1200px; margin: 0 auto 60px;">
		<h2 style="color:#0d3b5e; margin-bottom:10px;">You may also like</h2>
		<div style="position:relative;">
			<button id="relPrev" aria-label="Previous" style="position:absolute; left:-10px; top:40%; transform:translateY(-50%); z-index:2;" class="add-to-cart"><i class="fa-solid fa-chevron-left"></i></button>
			<div id="relatedTrack" style="display:flex; gap:16px; overflow:hidden; scroll-behavior:smooth; padding:10px 5px;"></div>
			<button id="relNext" aria-label="Next" style="position:absolute; right:-10px; top:40%; transform:translateY(-50%); z-index:2;" class="add-to-cart"><i class="fa-solid fa-chevron-right"></i></button>
		</div>
	</div>

	<footer class="footer">
		<div class="footer-content"></div>
		<div class="footer-section">
			<h3>About Us</h3>
			<p>Welcome to our online store. We offer a wide range of products for your home and office.</p>
		</div>
	</footer>

	<script src="js/js.js"></script>
	<script src="js/cart.js"></script>
	<script src="js/notifications.js"></script>
	<script>
		function getQueryParam(name) {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get(name);
		}
		async function loadProductDetails() {
			const id = getQueryParam('id');
			if (!id) return;
			try {
				const res = await fetch('get_product_details.php?id=' + encodeURIComponent(id));
				const product = await res.json();
				if (!product || product.error) return;
				document.getElementById('productImage').src = product.cover || 'img/product/1.jpg';
				document.getElementById('productName').textContent = product.name || '';
				document.getElementById('productSummary').textContent = product.summary || '';
				document.getElementById('productPrice').textContent = (product.price ? product.price : '') + (product.Currancy ? ' ' + product.Currancy : '');
				document.getElementById('productDescription').textContent = product.description || '';
				// Bind actions
				document.getElementById('addToCartBtn').onclick = function() {
					addToCart({ id: product.id, name: product.name, price: parseFloat(product.price || 0), image: product.cover });
				};
				document.getElementById('addToWishlistBtn').onclick = function() { addToWishlist(product.id); };

				// Load comments and related products
				await Promise.all([loadComments(id), loadRelated(product)]);
				initRelatedControls();
			} catch(e) { console.error(e); }
		}

		async function loadComments(productId) {
			const list = document.getElementById('commentsList');
			list.innerHTML = 'Loading comments...';
			try {
				const resp = await fetch('comments.php?product_id=' + encodeURIComponent(productId));
				const data = await resp.json();
				if (data.status !== 'success') throw new Error(data.message || 'Failed');
				if (!data.items || data.items.length === 0) { list.innerHTML = '<div class="empty-wishlist">No comments yet</div>'; return; }
				list.innerHTML = data.items.map(it => `
					<div class="wishlist-item" style="align-items:flex-start;">
						<div class="wishlist-item-details">
							<h4 style="margin-bottom:4px;">${it.user_name || 'User'}</h4>
							<p style="white-space:pre-wrap;">${it.comment}</p>
							<p style="color:#999; font-size:12px; margin-top:6px;">${new Date(it.created_at).toLocaleString()}</p>
						</div>
					</div>
				`).join('');
			} catch(err) {
				console.error(err);
				list.innerHTML = '<div class="error-message">Failed to load comments</div>';
			}
			initCommentForm(productId);
		}

		function initCommentForm(productId) {
			const userData = JSON.parse(localStorage.getItem('userData'));
			const input = document.getElementById('commentInput');
			const btn = document.getElementById('submitComment');
			const hint = document.getElementById('commentHint');
			if (!userData || !userData.email) {
				input.disabled = true; btn.disabled = true; hint.style.display = 'block';
				btn.classList.add('disabled');
				return;
			}
			btn.onclick = async () => {
				const comment = (input.value || '').trim();
				if (!comment) return;
				btn.disabled = true;
				try {
					const resp = await fetch('comments.php', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ product_id: Number(productId), comment }) });
					const data = await resp.json();
					if (data.status === 'success') { input.value = ''; loadComments(productId); }
					else { alert(data.message || 'Failed to post'); }
				} catch(e) { console.error(e); alert('Failed to post'); }
				finally { btn.disabled = false; }
			};
		}

		async function loadRelated(product) {
			// Use same category/subcategory to find related; fallback to latest products
			try {
				const resp = await fetch('get_product.php');
				const all = await resp.json();
				const candidates = (Array.isArray(all) ? all : []).filter(p => 
					String(p.product_id || p.id) !== String(product.id) && 
					p.category_id === product.category_id
				);
				const related = candidates.slice(0, 12);
				const track = document.getElementById('relatedTrack');
				track.innerHTML = related.map(p => `
					<div class="product-card" style="min-width:260px; max-width:260px;">
						<div class="image-container"><a href="product-details.html?id=${p.product_id || p.id}"><img src="${p.cover}" class="product-image" alt="${p.name}"></a></div>
						<a href="product-details.html?id=${p.product_id || p.id}" class="product-name"><h3 class="product-name">${p.name}</h3></a>
						<p class="product-price">${p.price || ''} ${p.Currancy || ''}</p>
						<div class="product-buttons">
							<button onclick="addToWishlist(${p.product_id || p.id})" class="wishlist-btn" title="Add to wishlist" aria-label="Add to wishlist"><i class="fa-solid fa-heart" aria-hidden="true"></i></button>
							<button onclick="addToCart({ id: '${p.product_id || p.id}', name: '${p.name}', price: ${parseFloat(p.price || 0)}, image: '${p.cover}' })" class="add-to-cart"><i class="fa-solid fa-cart-shopping"></i> Add to Cart</button>
						</div>
					</div>
				`).join('');
			} catch(e) { console.error(e); }
		}

		function initRelatedControls() {
			const track = document.getElementById('relatedTrack');
			document.getElementById('relPrev').onclick = () => track.scrollBy({ left: -300, behavior: 'smooth' });
			document.getElementById('relNext').onclick = () => track.scrollBy({ left: 300, behavior: 'smooth' });
		}
		document.addEventListener('DOMContentLoaded', loadProductDetails);
	</script>
</body>
</html>
