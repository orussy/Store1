<?php
session_start();

// Simple session check - redirect if not logged in
if (!isset($_SESSION['user_id'])) {
    header('Location: index.html');
    exit();
}

// Get user data directly in PHP
require_once 'config/db.php';
$userId = $_SESSION['user_id'];

$userData = null;
$addressData = null;

try {
    // Get user data
    $userQuery = "SELECT id, email, f_name, l_name, phone_no, birthdate, 
                         role, status, created_at, gender, loyalty_points, avatar
                  FROM users 
                  WHERE id = ? AND deleted_at IS NULL";
    
    $userStmt = $conn->prepare($userQuery);
    $userStmt->bind_param("i", $userId);
    $userStmt->execute();
    $userResult = $userStmt->get_result();
    
    if ($userResult->num_rows > 0) {
        $userData = $userResult->fetch_assoc();
        
        // Get address data
        $addressQuery = "SELECT title, address1, address2, country, city, postal_code 
                         FROM addresses 
                         WHERE user_id = ? AND deleted_at IS NULL 
                         ORDER BY created_at DESC LIMIT 1";
        
        $addressStmt = $conn->prepare($addressQuery);
        $addressStmt->bind_param("i", $userId);
        $addressStmt->execute();
        $addressResult = $addressStmt->get_result();
        
        if ($addressResult->num_rows > 0) {
            $addressData = $addressResult->fetch_assoc();
        }
    }
    
    $userStmt->close();
    if (isset($addressStmt)) $addressStmt->close();
    
} catch (Exception $e) {
    // Handle error silently
}

$conn->close();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Store1</title>
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/user-profile.css">
    <link rel="stylesheet" href="style/user-profile-simple.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="left">
            <a href="dashboard.html">
                <img src="img/store logo with one element on a white background.png" alt="Store Logo">
            </a>
        </div>
        <div class="center">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div class="right">
            <img src="img/heart-solid.svg" alt="wishlist" class="nav-icon" onclick="toggleWishlist()">
            <img src="img/bell-solid.svg" alt="Security" class="nav-icon" onclick="toggleNotifications()">
            <img src="img/cart-shopping-solid.svg" alt="Cart" class="nav-icon" onclick="toggleCart()">
            <img src="img/phone-solid.svg" alt="Phone" class="nav-icon">
            
            <!-- Cart dropdown -->
            <div class="cart-dropdown" id="cartDropdown">
                <div class="cart-header">
                    <h3><i class="fa-solid fa-cart-shopping"></i> <a href="cart.html">Shopping Cart</a></h3>
                </div>
                <div id="cartItems"></div>
            </div>

            <!-- Wishlist dropdown -->
            <div class="wishlist-dropdown" id="wishlistDropdown">
                <div class="wishlist-header">
                    <h3><i class="fa-solid fa-heart"></i><a href="wishlist.html"> My Wishlist</a></h3>
                </div>
                <div id="wishlistItems"></div>
            </div>

            <!-- Notifications dropdown -->
            <div class="notifications-dropdown" id="notificationsDropdown">
                <div class="notifications-header">
                    <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
                </div>
                <div id="notificationsItems">
                    <!-- Notifications will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- Email and User section -->
            <div class="user-section">
                <span id="userEmail" class="user-email"><?php echo htmlspecialchars($userData['email'] ?? ''); ?></span>
                <a href="user-profile-simple.html" class="nav-link">
                    <img src="img/user-solid.svg" alt="Profile" class="nav-icon">
                </a>
                <a href="#" class="nav-link" onclick="logout()">
                    <img src="img/right-from-bracket-solid.svg" alt="Logout" class="nav-icon">
                </a>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="user-info">
                <div class="user-image-placeholder" id="userImageContainer">
                    <img src="<?php echo htmlspecialchars($userData['avatar'] ?? 'uploads/avatar.png'); ?>" alt="User Avatar" onerror="this.src='uploads/avatar.png';">
                </div>
                <div class="user-name-placeholder">
                    <span><?php echo htmlspecialchars(($userData['f_name'] ?? '') . ' ' . ($userData['l_name'] ?? '')); ?></span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#personal" class="nav-item active" data-section="personal">
                    <i class="fas fa-user"></i>
                    <span>Personal Information</span>
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Account Settings</span>
                </a>
                <a href="#history" class="nav-item" data-section="history">
                    <i class="fas fa-history"></i>
                    <span>History purchase</span>
                </a>
                <a href="#status" class="nav-item" data-section="status">
                    <i class="fas fa-shield-alt"></i>
                    <span>Account Status</span>
                </a>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Personal Information Section -->
            <div id="personal" class="section-content active">
                <h2>Personal Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Full Name:</label>
                        <span><?php echo htmlspecialchars(($userData['f_name'] ?? '') . ' ' . ($userData['l_name'] ?? '')); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Email:</label>
                        <span><?php echo htmlspecialchars($userData['email'] ?? 'Not provided'); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Phone:</label>
                        <span><?php echo htmlspecialchars($userData['phone_no'] ?? 'Not provided'); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Date of Birth:</label>
                        <span><?php echo $userData['birthdate'] ? date('F j, Y', strtotime($userData['birthdate'])) : 'Not provided'; ?></span>
                    </div>
                    <div class="info-item">
                        <label>Gender:</label>
                        <span><?php echo htmlspecialchars($userData['gender'] ?? 'Not provided'); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Loyalty Points:</label>
                        <span><?php echo htmlspecialchars($userData['loyalty_points'] ?? 0); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Account Created:</label>
                        <span><?php echo $userData['created_at'] ? date('F j, Y', strtotime($userData['created_at'])) : 'Not provided'; ?></span>
                    </div>
                </div>
            </div>

            <!-- Account Settings Section -->
            <div id="settings" class="section-content">
                <h2>Account Settings</h2>
                <div class="settings-container">
                    <!-- Edit Profile Section -->
                    <div class="settings-section">
                        <h3><i class="fas fa-user-edit"></i> Edit Profile Information</h3>
                        <form id="editProfileForm" class="edit-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editFirstName">First Name *</label>
                                    <input type="text" id="editFirstName" name="f_name" value="<?php echo htmlspecialchars($userData['f_name'] ?? ''); ?>" required>
                                </div>
                                <div class="form-group">
                                    <label for="editLastName">Last Name *</label>
                                    <input type="text" id="editLastName" name="l_name" value="<?php echo htmlspecialchars($userData['l_name'] ?? ''); ?>" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editPhone">Phone Number</label>
                                    <input type="tel" id="editPhone" name="phone" value="<?php echo htmlspecialchars($userData['phone_no'] ?? ''); ?>">
                                </div>
                                <div class="form-group">
                                    <label for="editBirthdate">Date of Birth</label>
                                    <input type="date" id="editBirthdate" name="birthdate" value="<?php echo htmlspecialchars($userData['birthdate'] ?? ''); ?>">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editGender">Gender</label>
                                <select id="editGender" name="gender">
                                    <option value="">Select Gender</option>
                                    <option value="male" <?php echo ($userData['gender'] ?? '') === 'male' ? 'selected' : ''; ?>>Male</option>
                                    <option value="female" <?php echo ($userData['gender'] ?? '') === 'female' ? 'selected' : ''; ?>>Female</option>
                                    <option value="other" <?php echo ($userData['gender'] ?? '') === 'other' ? 'selected' : ''; ?>>Other</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Profile
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Email Section -->
                    <div class="settings-section">
                        <h3><i class="fas fa-envelope"></i> Change Email Address</h3>
                        <form id="changeEmailForm" class="edit-form">
                            <div class="form-group">
                                <label for="currentEmail">Current Email</label>
                                <input type="email" id="currentEmail" value="<?php echo htmlspecialchars($userData['email'] ?? ''); ?>" readonly>
                            </div>
                            <div class="form-group">
                                <label for="newEmail">New Email Address *</label>
                                <input type="email" id="newEmail" name="new_email" required>
                            </div>
                            <div class="form-group">
                                <label for="emailVerificationCode">Verification Code</label>
                                <div class="verification-group">
                                    <input type="text" id="emailVerificationCode" name="verification_code" placeholder="Enter 6-digit code" maxlength="6">
                                    <button type="button" class="btn btn-secondary" onclick="sendEmailVerification()">
                                        <i class="fas fa-paper-plane"></i> Send Code
                                    </button>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Change Email
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password Section -->
                    <div class="settings-section">
                        <h3><i class="fas fa-lock"></i> Change Password</h3>
                        <form id="changePasswordForm" class="edit-form">
                            <div class="form-group">
                                <label for="currentPassword">Current Password *</label>
                                <input type="password" id="currentPassword" name="current_password" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password *</label>
                                <input type="password" id="newPassword" name="new_password" required>
                                <small class="password-requirements">Password must be at least 8 characters long</small>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password *</label>
                                <input type="password" id="confirmPassword" name="confirm_password" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Account Deactivation Section -->
                    <div class="settings-section">
                        <h3><i class="fas fa-user-slash"></i> Account Deactivation</h3>
                        <div class="deactivation-info">
                            <p><strong>Warning:</strong> This action will deactivate your account temporarily.</p>
                            <ul>
                                <li>You will be logged out immediately</li>
                                <li>You cannot access your account while deactivated</li>
                                <li>Your account will be automatically reactivated when you log in again</li>
                            </ul>
                        </div>
                        <button class="btn btn-deactivate" onclick="showDeactivateModal()">
                            <i class="fas fa-user-slash"></i> Deactivate Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section-content">
                <h2>Purchase History</h2>
                <p>Your purchase history will be displayed here.</p>
            </div>

            <!-- Status Section -->
            <div id="status" class="section-content">
                <h2>Account Status</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Status:</label>
                        <span><?php echo htmlspecialchars($userData['status'] ?? 'active'); ?></span>
                    </div>
                    <div class="info-item">
                        <label>Role:</label>
                        <span><?php echo htmlspecialchars($userData['role'] ?? 'user'); ?></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate Account Modal -->
    <div id="deactivateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Deactivate Account</h3>
                <span class="close" onclick="closeDeactivateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <p><strong>Warning:</strong> This action will deactivate your account.</p>
                    <ul>
                        <li>You will be logged out immediately</li>
                        <li>You cannot access your account while deactivated</li>
                        <li>Your account will be automatically reactivated when you log in again</li>
                        <li>This is different from being blocked (which requires admin intervention)</li>
                    </ul>
                </div>
                <form id="deactivateForm">
                    <div class="form-group">
                        <label for="deactivateReason">Reason for deactivation (optional):</label>
                        <textarea id="deactivateReason" name="reason" rows="3" placeholder="Enter your reason for deactivating..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="closeDeactivateModal()">Cancel</button>
                        <button type="submit" class="btn btn-deactivate">Deactivate Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Simple navigation without AJAX
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section-content');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all items and sections
                    navItems.forEach(nav => nav.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = this.getAttribute('data-section');
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });

            // Handle form submissions
            document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);
            document.getElementById('changeEmailForm').addEventListener('submit', handleChangeEmail);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('deactivateForm').addEventListener('submit', handleDeactivate);
        });

        function logout() {
            localStorage.removeItem('userData');
            fetch('logout.php')
                .finally(() => {
                    window.location.href = 'index.html';
                });
        }

        function showDeactivateModal() {
            document.getElementById('deactivateModal').style.display = 'block';
        }

        function closeDeactivateModal() {
            document.getElementById('deactivateModal').style.display = 'none';
            document.getElementById('deactivateForm').reset();
        }

        // Form handlers
        async function handleEditProfile(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('update_user_profile.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Profile updated successfully!');
                    location.reload(); // Reload to show updated data
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating profile');
            }
        }

        async function handleChangeEmail(e) {
            e.preventDefault();
            
            const newEmail = document.getElementById('newEmail').value;
            const verificationCode = document.getElementById('emailVerificationCode').value;
            
            if (!verificationCode) {
                alert('Please enter the verification code');
                return;
            }
            
            const formData = new FormData();
            formData.append('new_email', newEmail);
            formData.append('verification_code', verificationCode);
            
            try {
                const response = await fetch('change_email.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Email changed successfully!');
                    location.reload(); // Reload to show updated data
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error changing email');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            
            const formData = new FormData();
            formData.append('current_password', currentPassword);
            formData.append('new_password', newPassword);
            
            try {
                const response = await fetch('change_password.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Password changed successfully!');
                    e.target.reset();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error changing password');
            }
        }

        async function handleDeactivate(e) {
            e.preventDefault();
            
            const reason = document.getElementById('deactivateReason').value;
            
            if (confirm('Are you sure you want to deactivate your account? This action cannot be undone immediately.')) {
                const formData = new FormData();
                formData.append('reason', reason);
                
                try {
                    const response = await fetch('deactivate_account.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.href = 'index.html';
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deactivating account');
                }
            }
        }

        async function sendEmailVerification() {
            const newEmail = document.getElementById('newEmail').value;
            
            if (!newEmail) {
                alert('Please enter a new email address first');
                return;
            }
            
            const formData = new FormData();
            formData.append('new_email', newEmail);
            
            try {
                const response = await fetch('send_email_verification.php', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('Verification code sent to your new email address!');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending verification code');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('deactivateModal');
            if (event.target === modal) {
                closeDeactivateModal();
            }
        }
    </script>
    <script src="js/notifications.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/wishlist.js"></script>
</body>
</html>
